!function(){function Question(slug,text){this.slug=slug,this.text=text}function Answer(key,text,starCount,isStarred,flagCount,order,userId){this.key=key,this.text=text,this.starCount=ko.observable(starCount),this.isStarred=ko.observable(isStarred),this.flagCount=ko.observable(flagCount),this.order=order,this.userId=userId}function AppViewModel(){var self=this;this.isHome=ko.observable(!0),this.questionText=ko.observable("What's most important?"),this.questionSlug=ko.observable("important"),this.prevQuestionSlug=ko.observable(!1),this.username=ko.observable("Sign in"),this.isSignedIn=ko.observable(!1),this.inputPlaceholder=ko.observable("Sign in to answer."),this.prevQ=ko.observable("#/q/suggest"),this.nextQ=ko.observable("#/q/life"),this.canAddAnswer=ko.observable(!1),this.newAnswer=ko.observable(""),this.shouldShowCounter=ko.observable(!1),this.charsLeft=ko.observable(160),this.currentSorting=ko.observable("time"),this.prevSorting=ko.observable("time"),this.importantCount=ko.observable(0),this.lifeCount=ko.observable(0),this.experienceCount=ko.observable(0),this.differenceCount=ko.observable(0),this.messageCount=ko.observable(0),this.needCount=ko.observable(0),this.fearCount=ko.observable(0),this.happyCount=ko.observable(0),this.missionCount=ko.observable(0),this.suggestCount=ko.observable(0),this.showLoading=ko.observable(!0),this.hasAnswers=ko.observable(!1),this.hasNotAnswered=ko.observable(!1),this.pendingCred=ko.observable(null),this.showCredError=ko.observable(!1),this.provider=ko.observable("google.com"),this.prevText=ko.observable(null),this.showConfirmation=ko.observable(!1),this.showReporting=ko.observable(!1),this.deleteRef=ko.observable(null),this.answerToReport=ko.observable(null),this.currentUserId=ko.observable(null),this.answers=ko.observableArray([]),this.userStars=ko.observableArray([]),this.userFlags=ko.observableArray([]),this.launchPopUp=function(){self.provider().indexOf("google")>-1?firebase.auth().signInWithPopup(googleProvider).then(function(result){result.user.link(self.pendingCred()),this.showCredError(!1)}):self.provider().indexOf("facebook")>-1?firebase.auth().signInWithPopup(facebookProvider).then(function(result){result.user.link(self.pendingCred()),this.showCredError(!1)}):self.provider().indexOf("twitter")>-1&&firebase.auth().signInWithPopup(twitterProvider).then(function(result){result.user.link(self.pendingCred()),this.showCredError(!1)})},this.closeCred=function(){this.showCredError(!1)},this.hashChange=function(event){var currentHash=window.location.hash.substr(1);if(self.currentSorting("time"),self.hasNotAnswered(!1),document.body.scrollTop=document.documentElement.scrollTop=0,"/"===currentHash)self.isHome(!0);else if(0===currentHash.indexOf("/q/")){var questionSlug=currentHash.substr(3);questionSlugArray.indexOf(questionSlug)>-1?(self.prevQuestionSlug()?self.prevQuestionSlug()!=self.questionSlug()&&self.prevQuestionSlug(self.questionSlug()):self.prevQuestionSlug(questionSlug),self.questionSlug(questionSlug),self.renderQuestionPage(questionSlugArray.indexOf(questionSlug))):history.pushState?(window.history.pushState(null,null,"#/"),self.hashChange()):(window.location.hash="#/",self.hashChange())}else history.pushState?(window.history.pushState(null,null,"#/"),self.hashChange()):(window.location.hash="#/",self.hashChange())},this.renderQuestionPage=function(question){var newPrevLink=0!=question?question-1:9;newPrevLink=questionArray[newPrevLink].slug,self.prevQ("#/q/"+newPrevLink);var newNextLink=9!=question?question+1:0;newNextLink=questionArray[newNextLink].slug,self.nextQ("#/q/"+newNextLink),self.questionText(questionArray[question].text),self.isHome(!1),self.renderAnswers()},this.getUserFlags=function(){if(firebase.auth().currentUser){var flagsRef=firebase.database().ref("users/"+firebase.auth().currentUser.uid+"/flags/");flagsRef.on("child_added",function(data){data.val().isFlagged&&self.userFlags.push(data.key)})}},this.getUserStars=function(){if(firebase.auth().currentUser){var starsRef=firebase.database().ref("users/"+firebase.auth().currentUser.uid+"/stars/");starsRef.on("child_added",function(data){data.val().isStarred&&self.userStars.push(data.key)}),starsRef.on("child_removed",function(data){self.userStars.remove(data.key)}),self.renderAnswers()}},this.renderAnswers=function(){var noAnswers=!1,needsSortByStars=!1;self.showLoading(!0),self.hasAnswers(!1),self.answers.removeAll(),firebase.database().ref("answers/"+this.prevQuestionSlug()).off();var answersRef=firebase.database().ref("answers/"+this.questionSlug());switch(self.currentSorting()){case"time":answersRef=answersRef.orderByChild("order");break;case"stars":answersRef=answersRef.orderByChild("starCount"),needsSortByStars=!0;break;case"shuffle":answersRef=answersRef.orderByChild("userId");break;case"user":firebase.auth().currentUser?answersRef=answersRef.orderByChild("userId").equalTo(firebase.auth().currentUser.uid):(self.hasAnswers(!1),noAnswers=!0),self.hasNotAnswered(!0),self.showLoading(!1)}noAnswers||(answersRef.on("child_added",function(data){if(self.userFlags.indexOf(data.key)===-1){var shouldStar=!1;self.userStars.indexOf(data.key)>-1&&(shouldStar=!0);var newAnswer=new Answer(data.key,data.val().text,data.val().starCount,shouldStar,data.val().flagCount,data.val().order,data.val().userId);self.pushNewAnswer(data.val().text,newAnswer),self.hasAnswers(!0),self.showLoading(!1),self.hasNotAnswered(!1),needsSortByStars&&self.sortAnswersByStars()}}),answersRef.on("child_removed",function(data){self.answers.remove(function(answer){return answer.key===data.key})}))},this.pushNewAnswer=function(text,answer){self.prevText()!=text&&(self.answers.push(answer),self.prevText(text))},this.handleKeyDown=function(data,event){return 13!==event.which||(this.addNewAnswer(),!1)},this.handleKeyUp=function(){var charCount=this.newAnswer().length;return charCount>=100?this.shouldShowCounter(!0):this.shouldShowCounter(!1),this.charsLeft(160-charCount),charCount>160?this.canAddAnswer(!1):charCount>=2&&this.canAddAnswer(!0),self.newAnswer(self.filterProfanity(self.newAnswer())),!0},this.writeNewAnswer=function(question,text){var question=question||window.location.hash.substr(4),newAnswerText=text,ordering=0-new Date;firebase.database().ref("answers/"+question).push({userId:firebase.auth().currentUser.uid,text:newAnswerText,starCount:0,timestamp:firebase.database.ServerValue.TIMESTAMP,order:ordering}).then(function(result){result&&(firebase.database().ref("questions/"+question+"/answerCount").transaction(function(currentCount){return currentCount+1}),"time"!==self.currentSorting()&&"user"!==self.currentSorting()||self.sortAnswersByTime())})},this.addNewAnswer=function(){var newAnswer=self.filterProfanity(this.newAnswer());newAnswer.length>=2&&newAnswer.length<=160&&(this.newAnswer(""),this.shouldShowCounter(!1),this.charsLeft(160),this.canAddAnswer(!1),self.writeNewAnswer(self.questionSlug(),newAnswer))},this.clickAccountModalTrigger=function(){self.isSignedIn()||document.getElementById("account-modal-trigger").focus()},this.toggleStar=function(answer){var incr=answer.isStarred()?-1:1;answer.isStarred(!answer.isStarred()),1===incr?firebase.database().ref("users/"+firebase.auth().currentUser.uid+"/stars/"+answer.key).set({isStarred:!0}).then(function(){firebase.database().ref("answers/"+self.questionSlug()+"/"+answer.key+"/starCount").transaction(function(currentCount){return currentCount+1}),answer.starCount(answer.starCount()+1),"stars"===self.currentSorting()&&self.sortAnswersByStars()}):incr===-1&&firebase.database().ref("users/"+firebase.auth().currentUser.uid+"/stars/"+answer.key).remove().then(function(){firebase.database().ref("answers/"+self.questionSlug()+"/"+answer.key+"/starCount").transaction(function(currentCount){return currentCount-1}),answer.starCount(answer.starCount()-1),"stars"===self.currentSorting()&&self.sortAnswersByStars()})},this.displayReporting=function(answer){self.answerToReport(answer),self.showReporting(!0)},this.flagAnswer=function(){if(null!=self.answerToReport()){var answer=self.answerToReport(),newFlagCount=void 0===answer.flagCount()?1:answer.flagCount()+1;newFlagCount>5?(firebase.database().ref("answers/"+self.questionSlug()+"/"+answer.key).remove().then(function(){firebase.database().ref("questions/"+self.questionSlug()+"/answerCount").transaction(function(currentCount){return currentCount-1})}),self.hideReporting()):firebase.database().ref("users/"+firebase.auth().currentUser.uid+"/flags/"+answer.key).set({isFlagged:!0}).then(function(){firebase.database().ref("answers/"+self.questionSlug()+"/"+answer.key+"/flagCount").transaction(function(){return newFlagCount}),answer.flagCount(newFlagCount),self.answers.remove(function(manswer){return manswer.key===answer.key}),self.hideReporting()})}},this.hideReporting=function(){self.answerToReport(null),self.showReporting(!1)},this.displayConfirmation=function(answer){var deleteRef=firebase.database().ref("answers/"+self.questionSlug()+"/"+answer.key);self.deleteRef(deleteRef),self.showConfirmation(!0)},this.deleteAnswer=function(){if(null!=self.deleteRef()){var answerToDelete=self.deleteRef();answerToDelete.remove().then(function(){firebase.database().ref("questions/"+self.questionSlug()+"/answerCount").transaction(function(currentCount){return currentCount-1})}),self.hideConfirmation()}},this.hideConfirmation=function(){self.deleteRef(null),self.showConfirmation(!1)},this.signInGoogle=function(){firebase.auth().signInWithRedirect(googleProvider)},this.signInFacebook=function(){firebase.auth().signInWithRedirect(facebookProvider)},this.signInTwitter=function(){firebase.auth().signInWithRedirect(twitterProvider)},this.updateUser=function(user){user&&(self.username(user.displayName),self.inputPlaceholder("Add an answer..."),self.isSignedIn(!0),self.currentUserId(user.uid),self.getUserFlags(),self.getUserStars())},this.signOut=function(){this.username("Sign in"),this.inputPlaceholder("Sign in to answer."),this.canAddAnswer(!1),this.isSignedIn(!1),self.currentUserId(null),self.userStars.removeAll(),self.userFlags.removeAll(),self.renderAnswers(),firebase.auth().signOut()},this.sortByTime=function(){self.prevSorting(self.currentSorting()),self.currentSorting("time"),"user"===self.prevSorting()?self.renderAnswers():self.sortAnswersByTime()},this.sortByStars=function(){self.prevSorting(self.currentSorting()),this.currentSorting("stars"),"user"===self.prevSorting()?self.renderAnswers():self.sortAnswersByStars()},this.shuffle=function(){self.prevSorting(self.currentSorting()),this.currentSorting("shuffle"),"user"===self.prevSorting()?self.renderAnswers():self.shuffleAnswers()},this.filterUser=function(){self.prevSorting(self.currentSorting()),this.currentSorting("user"),self.renderAnswers()},this.sortAnswers=function(){switch(self.currentSorting()){case"time":self.sortAnswersByTime();break;case"stars":self.sortAnswersByStars();break;case"shuffle":self.shuffleAnswers();break;case"user":self.renderAnswers()}},this.sortAnswersByTime=function(){self.answers.sort(function(left,right){return left.order>right.order?1:-1})},this.sortAnswersByStars=function(){self.answers.sort(function(left,right){return left.starCount()===right.starCount()?left.order<right.order?1:-1:left.starCount()<right.starCount()?1:-1})},this.shuffleAnswers=function(){self.answers.sort(function(left,right){return Math.floor(2*Math.random())?1:-1})},this.checkForUser=function(){firebase.auth().currentUser&&this.updateUser(firebase.auth().currentUser)},this.filterProfanity=function(text){return(text.indexOf("fuck")||text.indexOf("cunt")||text.indexOf("bitch")||text.indexOf("shit"))&&(text=text.replace(/fuck/gi,"(cuss)"),text=text.replace(/cunt/gi,"(cuss)"),text=text.replace(/bitch/gi,"(cuss)"),text=text.replace(/shit/gi,"(cuss)")),text}}window.fbAsyncInit=function(){FB.init({appId:"735344409890243",xfbml:!0,version:"v2.7"})},function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];d.getElementById(id)||(js=d.createElement(s),js.id=id,js.src="//connect.facebook.net/en_US/sdk.js",fjs.parentNode.insertBefore(js,fjs))}(document,"script","facebook-jssdk");var config={apiKey:"AIzaSyD0S_BCQ3wBsSRE3PFRbtcsXRBVbHIy7I4",authDomain:"answers-from-all.firebaseapp.com",databaseURL:"https://answers-from-all.firebaseio.com",storageBucket:"answers-from-all.appspot.com"};firebase.initializeApp(config);var googleProvider=new firebase.auth.GoogleAuthProvider,facebookProvider=new firebase.auth.FacebookAuthProvider,twitterProvider=new firebase.auth.TwitterAuthProvider,questionSlugArray=["important","life","experience","difference","message","need","fear","happy","mission","suggest"],questionArray=[new Question("important","What is most important?"),new Question("life","How do you make the most of life?"),new Question("experience","What is the best experience a person can have?"),new Question("difference","How will you make a difference?"),new Question("message","If you could send a message to the world, what would it be?"),new Question("need","What does the world need?"),new Question("fear","What do you fear most?"),new Question("happy","What makes you most happy?"),new Question("mission","What is your mission statement?"),new Question("suggest","Suggest a question!")],appViewModel=new AppViewModel;if(ko.applyBindings(appViewModel),"onhashchange"in window)window.addEventListener?window.addEventListener("hashchange",appViewModel.hashChange,!1):window.attachEvent&&window.attachEvent("onhashchange",appViewModel.hashChange);else{var oldHref=location.href;setInterval(function(){var newHref=location.href;if(oldHref!==newHref){var _oldHref=oldHref;oldHref=newHref,appViewModel.hashChange.call(window,{type:"hashchange",newURL:newHref,oldURL:_oldHref})}},100)}appViewModel.hashChange(),document.body.onclick=function(event){var target=event.target||event.srcElement,accountModal=document.getElementById("account-modal");return target===document.getElementById("account-modal-trigger")||target===document.getElementById("account-icon")?(accountModal.className="hide"===accountModal.className?"show":"hide",!0):void(target===accountModal||accountModal.contains(target)||"show"!==accountModal.className||(accountModal.className="hide"))},firebase.auth().getRedirectResult().then(function(result){appViewModel.updateUser(result.user)}).catch(function(error){var email=(error.message,error.email);if(console.log("Error: \n"+error.message+"\n"+error.email),"auth/account-exists-with-different-credential"===error.code){var pendingCred=error.credential;appViewModel.pendingCred(pendingCred);var email=error.email;firebase.auth().fetchProvidersForEmail(email).then(function(providers){appViewModel.provider(providers[0]),appViewModel.showCredError(!0)})}}),firebase.database().ref("questions/important/answerCount").on("value",function(snapshot){appViewModel.importantCount(snapshot.val())}),firebase.database().ref("questions/life/answerCount").on("value",function(snapshot){appViewModel.lifeCount(snapshot.val())}),firebase.database().ref("questions/experience/answerCount").on("value",function(snapshot){appViewModel.experienceCount(snapshot.val())}),firebase.database().ref("questions/difference/answerCount").on("value",function(snapshot){appViewModel.differenceCount(snapshot.val())}),firebase.database().ref("questions/message/answerCount").on("value",function(snapshot){appViewModel.messageCount(snapshot.val())}),firebase.database().ref("questions/need/answerCount").on("value",function(snapshot){appViewModel.needCount(snapshot.val())}),firebase.database().ref("questions/fear/answerCount").on("value",function(snapshot){appViewModel.fearCount(snapshot.val())}),firebase.database().ref("questions/happy/answerCount").on("value",function(snapshot){appViewModel.happyCount(snapshot.val())}),firebase.database().ref("questions/mission/answerCount").on("value",function(snapshot){appViewModel.missionCount(snapshot.val())}),firebase.database().ref("questions/suggest/answerCount").on("value",function(snapshot){appViewModel.suggestCount(snapshot.val())}),firebase.auth().onAuthStateChanged(function(user){user&&appViewModel.updateUser(user)})}();
